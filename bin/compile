#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e

indent() {
  sed -u 's/^/       /'
}

echo "-----> Installing Subversion..."

echo "-----> Downloading Subversion"
curl --location --silent --output subversion-1.8.5.tar.bz2 http://mirror.catn.com/pub/apache/subversion/subversion-1.8.5.tar.bz2
tar -xjf subversion-1.8.5.tar.bz2
cd subversion-1.8.5

echo "-----> Installing Subversion Dependencies"
./get-deps.sh apr | indent
cd apr/; ./buildconf | indent; ./configure | indent; make | indent; cd ..
cd apr-util/; ./buildconf | indent; ./configure | indent; make | indent; cd ..
cd apr-util/xml/expat/; ./buildconf.sh | indent; ./configure | indent; make | indent; cd ../../..
./autogen.sh | indent

echo "-----> Building Subversion"
./configure \
	--disable-mod-activation \
	--without-apxs \
	--without-berkeley-db \
	--without-serf \
	--without-swig \
	--without-ctypesgen \
	--without-kwallet \
	--without-gnome-keyring \
	--disable-javahl \
	--disable-keychain \
	-C \
	--with-apr=apr \
	--with-apr-util=apr-util | indent

make mkdir-init fsmod-lib ramod-lib lib bin | indent

echo "-----> Testing Subversion"
make check TESTS="`echo subversion/tests/cmdline/{basic_tests.py,merge_tests.py}`" | indent

echo "-----> Installing Subversion binaries"
make install | indent
