#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e            # fail fast
set -o pipefail   # don't ignore exit codes when piping output

build_dir=$1
cache_dir=$2
bp_dir=$(cd $(dirname $0); cd ..; pwd)
subversion_version=1.8.5

indent() {
	sed -u 's/^/       /'
}

if test -f $cache_dir/svnx; then
	echo "-----> Subversion already built"
else
	echo "-----> Downloading Subversion $subversion_version"
	curl --location --silent --output subversion-$subversion_version.tar.bz2 http://mirror.catn.com/pub/apache/subversion/subversion-$subversion_version.tar.bz2
	tar -xjf subversion-$subversion_version.tar.bz2
	cp -R $bp_dir/sqlite-amalgamation subversion-$subversion_version
	cd subversion-$subversion_version

	echo "-----> Installing Subversion Dependencies"
	./get-deps.sh apr | indent
	cd apr/; ./buildconf | indent; ./configure | indent; make | indent; cd ..
	cd apr-util/; ./buildconf | indent; ./configure --with-apr=../apr | indent; make | indent; cd ..
	cd apr-util/xml/expat/; ./buildconf.sh | indent; ./configure | indent; make | indent; cd ../../..
	./autogen.sh | indent

	echo "-----> Building Subversion"
	./configure \
	    --disable-shared \
		--without-swig \
		--without-kwallet \
		--disable-keychain \
		-C \
		--with-sqlite=sqlite-amalgamation/sqlite3.c \
		--with-apr=apr \
		--with-apr-util=apr-util | indent

	make subversion/svn/svn subversion/svnmucc/svnmucc | indent

	echo "-----> Testing svn"
	subversion/svn/svn --version | indent

	echo "-----> Testing svnmucc"
	subversion/svnmucc/svnmucc --version | indent

	echo "-----> Copying svn and svnmucc binaries to cache"
	mkdir -p $cache_dir/subversion/bin
	cp subversion/svn/svn $cache_dir
	cp subversion/svnmucc/svnmucc $cache_dir
fi

echo "-----> Copying svn binaries to $build_dir/bin"
mkdir -p $build_dir/bin
cp $cache_dir/svn $build_dir/bin
cp $cache_dir/svnmucc $build_dir/bin

$build_dir/bin/svn --version | indent
