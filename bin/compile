#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e

BUILD_DIR=$1
CACHE_DIR=$2

indent() {
  sed -u 's/^/       /'
}

echo "-----> Installing Subversion..."

echo "BUILD_DIR=$BUILD_DIR" | indent
echo "BUILD_DIR=$CACHE_DIR" | indent
echo "PWD=`pwd`" | indent

echo "-----> Downloading Subversion"
curl --location --silent --output subversion-1.8.5.tar.bz2 http://mirror.catn.com/pub/apache/subversion/subversion-1.8.5.tar.bz2
tar -xjf subversion-1.8.5.tar.bz2
cd subversion-1.8.5

echo "-----> Installing Subversion Dependencies"
./get-deps.sh apr sqlite | indent
cd apr/; ./buildconf | indent; ./configure | indent; make | indent; cd ..
cd apr-util/; ./buildconf | indent; ./configure --with-apr=../apr | indent; make | indent; cd ..
cd apr-util/xml/expat/; ./buildconf.sh | indent; ./configure | indent; make | indent; cd ../../..
./autogen.sh | indent

echo "-----> Building Subversion"
./configure \
	--without-swig \
	--without-kwallet \
	--disable-keychain \
	-C \
	--with-sqlite=sqlite-amalgamation/sqlite3.c \
	--with-apr=apr \
	--with-apr-util=apr-util | indent

make subversion/svn/svn subversion/svnmucc/svnmucc | indent

echo "-----> Testing svn"
subversion/svn/svn --version | indent

echo "-----> Testing svnmucc"
subversion/svnmucc/svnmucc --version | indent
